{% extends "_base.html" %}
{% load static compress %}

{% block extratitle %}Cartographie{% endblock extratitle %}
{% block meta_description %}Cartographie des porteurs et programmes par département{% endblock meta_description %}

{% block extra_head %}
<meta property="og:title" content="Aides-territoires | Cartographie" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://aides-territoires.beta.gouv.fr" />
<meta property="og:site_name" content="Aides-territoires" />
<meta property="og:image" content="https://aides-territoires.beta.gouv.fr/static/img/logo_AT_og.png" />
<meta property="og:image:alt" content="Logo : Aides-territoires" />
{% endblock extra_head %}

{% block breadcrumbs %}
<div class="fr-container">
    <nav role="navigation" class="fr-breadcrumb" aria-label="vous êtes ici :">
        <button class="fr-breadcrumb__button" aria-expanded="false" aria-controls="breadcrumb-1">Voir le fil d’Ariane</button>
        <div class="fr-collapse" id="breadcrumb-1">
            <ol class="fr-breadcrumb__list">
                <li>
                    <a class="fr-breadcrumb__link" href="{% url 'home' %}">Accueil</a>
                </li>
                <li>
                    <a class="fr-breadcrumb__link" aria-current="page">Cartographie</a>
                </li>
            </ol>
        </div>
    </nav>
</div>
{% endblock breadcrumbs %}

{% block content %}
<article id="map-page" class="fr-container fr-mb-5w fr-pb-5w">
    <h2>Sélectionner un département sur la carte</h2>
    <div id="france-map" class="fr-mt-4w">
        {% include "map/france_departments.svg" %}
    </div>

    <h2>Sélectionner un département dans la liste</h2>
    <ul>
    {% for department in departments %}
        <li><a href="{% url 'department_view' department.code department.name|slugify %}">
            {{ department.name }} : {{ department.backers_count }} porteurs et {{ department.programs_count }} programmes
        </a></li>
    {% endfor %}
    </ul>

</article>
{% endblock content %}

{% block extra_css %}
    <style>
    #france-map {
        text-align:center;
        max-width: 800px;
        margin:auto;
    }

    .land {
        fill: #bccdff;
        stroke: #fff;
    }

    .land:hover {
        fill: #8ca4ff;
    }
    </style>
{% endblock extra_css %}

{% block extra_js %}
    <script>
    $(document).ready(function () {
        let departments_data = JSON.parse("{{ departments_list|escapejs }}");

        let get_department_data = function(selected_path) {
            // Retrieves the data from the selected path and an array of objects
            // that was passed through JSON
            let department_code = selected_path.attr('data-num');
            let department_data = departments_data.find(d => d.code === department_code);
            if (department_data) {
                return department_data;
            } else {
                return {}
            }

        };

        $('#france-map .land').hover(function() {
            // Shows a description on hover
            let selected_path = $( this );
            let data = get_department_data(selected_path);
            if ("code" in data) {
                $('#france-map title').text(`${data.name} : ${data.backers_count} porteurs et ${data.programs_count} programmes`);
            } else {
                $('#france-map title').text("Impossible de trouver les données pour ce département.");
            }
        });

        $('#france-map .land').click(function() {
            // Goes to the selected department entry on click
            let selected_path = $( this );
            let data = get_department_data(selected_path);
            if ("code" in data) {
                let new_url = window.location.origin + "/cartographie/" + data.code + '-' + data.slug + '/';
                window.location = new_url; 
            }
        });
        
    });
    </script>
{% endblock extra_js %}