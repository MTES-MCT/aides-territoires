{% extends "_base.html" %}

{% block extratitle %}Supprimer mon compte{% endblock extratitle %}

{% block extraclasses %}light{% endblock extraclasses %}

{% block sectionid %}profile-form{% endblock sectionid %}

{% block breadcrumbs %}
<div class="fr-container">
    <nav role="navigation" class="fr-breadcrumb" aria-label="vous êtes ici :">
        <button class="fr-breadcrumb__button" aria-expanded="false" aria-controls="breadcrumb-1">Voir le fil d’Ariane</button>
        <div class="fr-collapse" id="breadcrumb-1">
            <ol class="fr-breadcrumb__list">
                <li>
                    <a class="fr-breadcrumb__link" href="{% url 'home' %}">Accueil</a>
                </li>
                <li>
                    <a class="fr-breadcrumb__link" href="{% url 'user_dashboard' %}">Mon compte</a>
                </li>
                <li>
                    <a class="fr-breadcrumb__link" aria-current="page">Supprimer mon comptel</a>
                </li>
            </ol>
        </div>
    </nav>
</div>
{% endblock breadcrumbs %}

{% block content %}
<div class="fr-container fr-my-5w">
    <div class="fr-grid-row fr-grid-row--center">

        {% include 'accounts/_sidebar_menu.html' with user_parameter=True %}

        <div class="fr-col-md-9">
            <h1 class="fr-h3">Supprimer mon compte</h1>

            <div role="alert" class="fr-alert fr-alert--warning fr-alert--sm fr-mb-5w">
                <p>
                    Vous vous apprêtez à supprimer votre compte. Cette action est définitive !
                    Merci de prendre le temps de vérifier les informations qui vont être supprimées lors de la suppression du compte.
                </p>
            </div>

            <h2 class="fr-h4">Structure</h2>
            {% if organization_members.count > 1 %}
                <p>
                    La structure « {{ organization }} » compte d’autres membres que vous : elle ne sera donc pas supprimée.
                </p>
            {% else %}
                <p>
                    Vous êtes la seule personne appartenant à la structure « {{ organization }} ».
                    Si vous supprimez votre compte elle sera donc également supprimée.
                </p>
                
            {% endif %}

            {% if projects.count > 0 %}
                <h2 id="projects" class="fr-h4">Projets</h2>
                {% if organization_members.count > 1 %}
                    <p>Vous pouvez transférer la propriété des projets suivants à un autre membre de votre structure  « {{ organization }} ».</p>
                {% else %}
                    <p>
                        Les projets suivants seront supprimés. Si vous voulez les transférer à un autre utilisateur,
                        vous pouvez l’inviter à rejoindre votre structure ou demander à ce qu’il vous invite.
                        Vous pourrez alors transférer la propriété du projet à cette personne.
                    </p>
                {% endif %}

                <div class="fr-table at-table--fullwidth">
                    <table class="data-table" aria-describedby="projects">
                        <thead>
                            <tr>
                                <th scope="col" class="fr-text">Nom</th>
                                <th scope="col" class="fr-text">Nombre d’aides ajoutées</th>
                                <th scope="col" class="fr-text">Date création</th>
                                <th scope="col" class="fr-text">Date d’échéance</th>
                                <th scope="col" class="fr-text">Créé par</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for project in projects %}
                            <tr>
                                <td class="fr-text">
                                    <a href="{{ project.get_absolute_url }}">
                                        {{ project.name }}
                                    </a>
                                </td>
                                <td class="fr-text">
                                    {{ project.aid_set.all.count }}
                                </td>
                                <td class="fr-text">{{ project.date_created|date:'d/m/y' }}</td>
                                <td class="fr-text">{{ project.due_date|date:'d/m/y' }}</td>
                                <td class="fr-text">
                                {% if project.author %}
                                {% for author in project.author.all %}
                                {% if author == user %}
                                Vous
                                {% else %}
                                    {{ author.first_name }} {{ author.last_name }}
                                {% endif %}
                                {% endfor %}
                                {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if organization_members.count > 1 %}
                    <div class="fr-select-group">
                        <label class="fr-label" for="select">
                            Transférer les projets à :
                        </label>
                        <select class="fr-select" id="select" name="select">
                            <option value="" selected disabled hidden>Selectionnez une personne</option>
                            {% for member in organization_members %}
                                {% if member.id != user.id %}
                                    <option value="{{ member.id }}">{{ member.full_name }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                {% endif %}

            {% endif %}

            {% if aids.count > 0 %}
                <h2 id="aids" class="fr-h4">Aides</h2>
                <p>Les aides suivantes vont être supprimées :</p>

                <div class="fr-table at-table--fullwidth">
                    <table class="data-table" aria-describedby="aids">
                        <caption class="sr-only">
                            Liste de vos aides publiées
                        </caption>
                        <thead>
                            <tr>
                                <th scope="col">Nom de l’aide</th>
                                <th scope="col">Périmètre</th>
                                <th scope="col">Créée le</th>
                                <th scope="col">Modifiée le</th>
                                <th scope="col">Échéance</th>
                                <th scope="col">Visibilité sur le site</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for aid in aids %}
                            <tr>
                                <td>
                                    <a href="{% url 'aid_edit_view' aid.slug %}">
                                        {{ aid.name }}
                                    </a>
                                    {% if aid.is_live %}
                                        <p class="fr-badge fr-badge--success fr-badge--sm">Affichée</p>
                                    {% endif %}
                                </td>
                                <td>{{ aid.perimeter }}</td>
                                <td>{{ aid.date_created|date:'d/m/Y' }}</td>
                                <td>{{ aid.date_updated|date:'d/m/Y' }}</td>
                                <td class="nowrap-cell">
                                    <span>{{ aid.submission_deadline|date:'d/m/Y' }}</span>
                                    {% if aid.is_ongoing %}
                                        <p class="fr-badge fr-badge--info fr-badge--sm">Permanente</p>
                                    {% elif aid.has_approaching_deadline %}
                                        <p class="fr-badge fr-badge--new fr-badge--sm">Échéance proche</p>                       
                                    {% elif aid.has_expired %}
                                        <p class="fr-badge fr-badge--warning fr-badge--sm">Expirée</p>
                                    {% endif %}
                                </td>
                                <td class="nowrap-cell"><a href="{{ aid.get_absolute_url }}">{{ aid.get_status_display }}</a></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}

            {% if alerts.count > 0 %}
                <h2 id="alerts" class="fr-h4">Alertes</h2>
                <p>Les alertes suivantes vont être supprimées :</p>
                <div class="fr-table at-table--fullwidth">
                    <table class="data-table" aria-describedby="alerts">
                        <thead>
                            <tr>
                                <th scope="col">Nom</th>
                                <th scope="col">Fréquence</th>
                                <th scope="col">Date création</th>
                                <th scope="col">Dernière réception</th>
                            </tr>
                        </thead>
                        {% for alert in alerts %}
                        <tbody>
                            <tr>
                                <td>
                                    <a href="{% url 'search_view' %}?{{ alert.querystring }}" target="_blank" rel="noopener">
                                        {{ alert.title }}
                                    </a>
                                </td>
                                <td>{{ alert.get_alert_frequency_display }}</td>
                                <td>{{ alert.date_created|date:'d/m/y' }}</td>
                                <td>
                                    {% if alert.validated %}
                                    {{ alert.latest_alert_date|date:'d/m/y' }}
                                    {% else %}
                                    En attente de confirmation
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}

            <div>
                <a class="fr-btn fr-btn--icon-left fr-fi-delete-line btn_delete" href="{% url 'delete_user_account' %}">
                    Supprimer votre compte
                </a>
            </div>
            
        </div>
    </div>
</div>
{% endblock content %}